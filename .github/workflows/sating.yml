name: Fetch and Upload Satellite Image to Cloudflare R2

on:
  schedule:
    - cron: "*/10 * * * *"  # 每10分钟运行（UTC时间），按需启用
  workflow_dispatch:

jobs:
  fetch_and_upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch imgPath from SatImg and download image as satimg.jpg
        run: |
          cat << 'EOF' > fetch_satimg.js
          const https = require('https');
          const fs = require('fs');
          const vm = require('vm');

          function fetchText(url) {
            return new Promise((resolve, reject) => {
              https.get(url, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(data));
              }).on('error', reject);
            });
          }

          function fetchBinary(url, dest) {
            return new Promise((resolve, reject) => {
              https.get(url, (res) => {
                const file = fs.createWriteStream(dest);
                res.pipe(file);
                file.on('finish', () => file.close(resolve));
              }).on('error', reject);
            });
          }

          (async () => {
            try {
              const jsUrl = 'https://www.cwa.gov.tw/Data/js/obs_img/Observe_sat.js';
              const jsCode = await fetchText(jsUrl);

              const context = {};
              vm.createContext(context);
              vm.runInContext(jsCode, context);

              const imgPath = context.SatImg['Tab4']['Area1']['size0']['C'][0]['img'];
              const fullUrl = `https://www.cwa.gov.tw/Data/satellite/${imgPath}`;
              console.log('✅ Downloading:', fullUrl);

              await fetchBinary(fullUrl, 'satimg.jpg');
              console.log('✅ Saved as satimg.jpg');
            } catch (e) {
              console.error('❌ Error:', e.message);
              process.exit(1);
            }
          })();
          EOF

          node fetch_satimg.js

      - name: Set up Python (for AWS CLI)
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install AWS CLI
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade awscli

      - name: Upload satimg.jpg to Cloudflare R2 (overwrite existing)
        env:
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          set -e
          if [ -z "${R2_ACCOUNT_ID}" ] || [ -z "${AWS_ACCESS_KEY_ID}" ] || [ -z "${AWS_SECRET_ACCESS_KEY}" ] || [ -z "${R2_BUCKET}" ]; then
            echo "❌ Missing one of required secrets: R2_ACCOUNT_ID, R2_BUCKET, R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY"
            exit 1
          fi

          endpoint="https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com"
          echo "Uploading satimg.jpg to s3://${R2_BUCKET}/satimg.jpg via endpoint ${endpoint}"

          # 上传并覆盖同名对象；如需公开访问可在下面命令加 --acl public-read
          aws s3 cp satimg.jpg "s3://${R2_BUCKET}/satimg.jpg" --endpoint-url "${endpoint}" --content-type "image/jpeg" --cache-control "no-cache"

          echo "✅ Uploaded to R2 (object overwritten if existed)."
